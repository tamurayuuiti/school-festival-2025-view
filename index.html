<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3-1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .day-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 4px rgba(0,0,0,0.06), 0 2px 4px -2px rgba(0,0,0,0.06); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 小さな補助スタイル: カード内部の要素を同一高さで整えるため */
        .card-count { line-height: 1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">


    <!-- ローディング画面 -->
    <div id="loader-container" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 font-semibold">データベースから読み込み中...</p>
        </div>
    </div>


    <!-- メインコンテンツ -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 max-w-7xl opacity-0 transition-opacity duration-500 min-h-screen flex flex-col justify-center">
        <header class="text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-black text-gray-900 tracking-tight mb-2">SCAFE</h1>
        </header>


        <!-- 日付切り替えタブ -->
        <div class="flex justify-center mb-8">
            <div class="flex bg-gray-200 rounded-xl p-1.5 shadow-inner">
                <button id="day1-btn" class="day-btn w-32 py-2.5 px-4 rounded-lg font-semibold text-gray-600 focus:outline-none transition-all duration-300">1日目</button>
                <button id="day2-btn" class="day-btn w-32 py-2.5 px-4 rounded-lg font-semibold text-gray-600 focus:outline-none transition-all duration-300">2日目</button>
            </div>
        </div>


        <!-- 各ドリンクのカウンター表示エリア -->
        <main id="counters-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- JavaScriptによってカウンターカードがここに動的に生成されます -->
        </main>


        <!-- 統計情報フッター -->
        <footer class="mt-8 bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-200 pb-3 text-gray-800">本日の総計 (<span id="current-day-stats"></span>)</h2>
            <div class="flex justify-between items-center text-lg">
                <span class="font-medium text-gray-600">合計売上金額:</span>
                <span id="total-price" class="font-bold text-3xl text-green-600">¥0</span>
            </div>
        </footer>
    </div>


    <script type="module">
        // Firebase SDK（読み取りに必要な関数のみ）
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";


        // --- 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDSzTii6D1Y7piVxNWfcZpbG2vPCFIcr4",
            authDomain: "school-festival-2025.firebaseapp.com",
            databaseURL: "https://school-festival-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "school-festival-2025",
            storageBucket: "school-festival-2025.firebasestorage.app",
            messagingSenderId: "904182530357",
            appId: "1:904182530357:web:f3767d5d5ff02ff1e48c7c",
            measurementId: "G-5FJNWLCXKE"
        };
        
        const DRINKS = [
            { id: 'mitsuyaCider', name: '三ツ矢サイダー', color: 'bg-cyan-400' },
            { id: 'gingerAle', name: 'ジンジャーエール', color: 'bg-amber-400' },
            { id: 'grapeJuice', name: 'ぶどうジュース', color: 'bg-purple-500' }
        ];


        const LIMITS = {
            day1: { mitsuyaCider: 120, gingerAle: 120, grapeJuice: 120 },
            day2: { mitsuyaCider: 160, gingerAle: 120, grapeJuice: 120 }
        };


        const PRICE_PER_ITEM = 100;
        const MIN_COUNT = 0;
        const appId = 'drink-sales-counter-2025';


        // --- DOM要素 ---
        const loaderContainer = document.getElementById('loader-container');
        const appContainer = document.getElementById('app-container');
        const day1Btn = document.getElementById('day1-btn');
        const day2Btn = document.getElementById('day2-btn');
        const countersContainer = document.getElementById('counters-container');
        const totalPriceEl = document.getElementById('total-price');
        const currentDayStatsEl = document.getElementById('current-day-stats');


        // --- 状態管理 ---
        let db;
        let isInitialLoad = true;
        let listeners = [];
        let state = {
            currentDay: 'day1',
            counts: { mitsuyaCider: 0, gingerAle: 0, grapeJuice: 0 }
        };


        // --- 初期化 ---
        function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                setupEventListeners();
                switchDay('day1'); 
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                loaderContainer.innerHTML = `<div class="text-center"><p class='text-red-500'>エラー: アプリケーションの読み込みに失敗しました。</p><p class='text-xs text-gray-400 mt-2'>${error.message}</p></div>`;
            }
        }


        function setupEventListeners() {
            day1Btn.addEventListener('click', () => switchDay('day1'));
            day2Btn.addEventListener('click', () => switchDay('day2'));
        }


        // --- 日付切り替え ---
        function switchDay(day) {
            if (state.currentDay === day && !isInitialLoad) return;
            state.currentDay = day;
            listeners.forEach(l => off(l.ref, 'value', l.callback));
            listeners = [];
            state.counts = { mitsuyaCider: 0, gingerAle: 0, grapeJuice: 0 };
            renderUI();


            DRINKS.forEach(drink => {
                const countRef = ref(db, `counters/${appId}/${day}/${drink.id}/count`);
                const callback = (snapshot) => {
                    const count = snapshot.val();
                    // 書き込みは行わない。null の場合は表示上 0 とする
                    state.counts[drink.id] = (count === null) ? 0 : count;
                    renderUI();


                    if (isInitialLoad) {
                        loaderContainer.style.display = 'none';
                        appContainer.classList.remove('opacity-0');
                        isInitialLoad = false;
                    }
                };
                onValue(countRef, callback);
                listeners.push({ ref: countRef, callback: callback });
            });
            updateTabUI();
        }


        // --- UI描画 ---
        function renderUI() {
            renderCounters();
            updateTotalPrice();
        }


        function renderCounters() {
            countersContainer.innerHTML = '';
            const currentLimits = LIMITS[state.currentDay];


            DRINKS.forEach(drink => {
                const count = state.counts[drink.id] || 0;
                const maxCount = currentLimits[drink.id];
                const progress = (maxCount > 0) ? Math.min(100, (count / maxCount) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transition-all duration-300 hover:shadow-xl min-h-56";
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="w-4 h-4 rounded-full ${drink.color} mr-3"></div>
                        <h3 class="text-2xl font-bold text-gray-800">${drink.name}</h3>
                    </div>
                    <div class="flex items-baseline justify-center mt-2 space-x-2">
                        <span class="text-7xl font-extrabold text-gray-900 tracking-tighter card-count" aria-live="polite">${count}</span>
                        <span class="text-xl font-medium text-gray-400">/ ${maxCount}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 my-6 overflow-hidden">
                        <div class="h-4 transition-all duration-300 ${progress > 85 ? 'bg-red-500' : 'bg-indigo-500'}" style="width: ${progress}%"></div>
                    </div>
                `;
                countersContainer.appendChild(card);
            });
        }
        
        function updateTotalPrice() {
            const totalCount = Object.values(state.counts).reduce((sum, count) => sum + count, 0);
            totalPriceEl.textContent = `¥${(totalCount * PRICE_PER_ITEM).toLocaleString()}`;
        }
        
        function updateTabUI() {
            day1Btn.classList.toggle('active', state.currentDay === 'day1');
            day2Btn.classList.toggle('active', state.currentDay === 'day2');
            currentDayStatsEl.textContent = state.currentDay === 'day1' ? '1日目' : '2日目';
        }


        initialize();
    </script>
</body>
</html>
